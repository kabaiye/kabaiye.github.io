<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>武器基质属性筛选器</title>
    <script defer src="/assets/zmd_jizhi/js/back-to-home.js"></script>
    <link rel="stylesheet" href="/assets/zmd_jizhi/css/weapons.css">
</head>
<body>
    <div class="container">
        <h1>武器基质属性筛选器</h1>
        <div class="loading-info" id="loading-info">正在加载武器数据...</div>

        <!-- 分类标签组 -->
        <div class="category">
            <h2>基础属性</h2>
            <div class="tag-container" id="base-attributes">
                <!-- 动态生成 -->
            </div>
        </div>

        <div class="category">
            <h2>附加属性</h2>
            <div class="tag-container" id="additional-attributes">
                <!-- 动态生成 -->
            </div>
        </div>

        <div class="category">
            <h2>技能属性</h2>
            <div class="tag-container" id="skill-attributes">
                <!-- 动态生成 -->
            </div>
        </div>

        <!-- 控制按钮 -->
        <div class="controls">
            <button class="btn-clear" id="btn-clear">清空选择</button>
        </div>

        <div class="status" id="status">选择词条后展示包含对应词条的武器；</div>

        <div class="results" id="results">
            <!-- 动态渲染结果 -->
        </div>
    </div>

    <script>
        // 预定义分类（仅用于界面组织）
        const BASE_ATTRS = [
            "敏捷提升",
            "力量提升",
            "意志提升",
            "智识提升",
            "主能力提升"
        ];

        const ADDITIONAL_ATTRS = [
            "生命提升",
            "攻击提升",
            "物理伤害提升",
            "灼热伤害提升",
            "寒冷伤害提升",
            "自然伤害提升",
            "电磁伤害提升",
            "法术伤害提升",
            "暴击率提升",
            "源石技艺提升",
            "治疗效率提升",
            "终结技效率提升"
        ];

        // 所有武器数据
        let weaponsData = [];

        // 当前选中属性集合
        let selectedAttrs = new Set();

        // 当前按词条筛选后的结果（用于结果区内的星级/类型二次筛选）
        let currentAttrFilteredList = [];

        // 结果区筛选：星级、类型（空字符串表示「全部」）
        let resultStarFilter = '';
        let resultTypeFilter = '';

        // 从数据中提取的星级、类型选项（去重，init 时填充）
        let allStarLevels = [];
        let allTypes = [];

        // 初始化：加载 JSON 并构建界面
        async function init() {
            const response = await fetch('/assets/zmd_jizhi/json/weapons.json');
            if (!response.ok) {
                throw new Error(`无法加载 weapons.json: ${response.status}`);
            }
            weaponsData = await response.json();

            // 从 JSON 去重得到星级、类型选项（开销小，一次计算）
            const starOrder = ['四星', '五星', '六星'];
            allStarLevels = [...new Set(weaponsData.map(w => w.star_level))].sort(
                (a, b) => starOrder.indexOf(a) - starOrder.indexOf(b)
            );
            allTypes = [...new Set(weaponsData.map(w => w.type))].sort();

            // 更新加载信息
            const loadingInfoEl = document.getElementById('loading-info');
            loadingInfoEl.textContent = `已加载 ${weaponsData.length} 条武器数据`;

            // 提取所有唯一属性值（用于自动分类）
            const allAttributes = new Set();
            weaponsData.forEach(w => {
                allAttributes.add(w.effect_1);
                allAttributes.add(w.effect_2);
                allAttributes.add(w.effect_3);
            });

            // 自动分类：技能属性 = 所有属性 - 基础 - 附加
            const skillAttrs = [...allAttributes].filter(attr =>
                !BASE_ATTRS.includes(attr) && !ADDITIONAL_ATTRS.includes(attr)
            );

            // 渲染三组标签
            renderTags('base-attributes', BASE_ATTRS);
            renderTags('additional-attributes', ADDITIONAL_ATTRS);
            renderTags('skill-attributes', skillAttrs);

            // 绑定点击事件（统一处理）
            document.querySelectorAll('.tag').forEach(tag => {
                tag.addEventListener('click', toggleAttribute);
            });

            // 绑定清空按钮
            document.getElementById('btn-clear').addEventListener('click', clearSelection);

            // 初次渲染状态与结果
            updateStatus();
            filterWeapons();
        }

        // 渲染一组标签
        function renderTags(containerId, attributes) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            attributes.forEach(attr => {
                const tag = document.createElement('span');
                tag.className = 'tag';
                tag.textContent = attr;
                tag.setAttribute('data-attr', attr);
                container.appendChild(tag);
            });
        }

        // 切换选中状态
        function toggleAttribute(e) {
            const attr = e.currentTarget.getAttribute('data-attr');
            if (selectedAttrs.has(attr)) {
                selectedAttrs.delete(attr);
                e.currentTarget.classList.remove('selected');
            } else {
                selectedAttrs.add(attr);
                e.currentTarget.classList.add('selected');
            }
            updateStatus();
            filterWeapons();
        }

        // 更新状态提示
        function updateStatus() {
            const statusEl = document.getElementById('status');
            const count = selectedAttrs.size;

            if (count === 0) {
                statusEl.textContent = '请选择词条以筛选武器';
            } else {
                statusEl.textContent = `已选 ${count} 个词条，下方展示包含对应词条的武器`;
            }
        }

        // 清空所有选中
        function clearSelection() {
            selectedAttrs.clear();
            document.querySelectorAll('.tag').forEach(tag => {
                tag.classList.remove('selected');
            });
            updateStatus();
            filterWeapons();
        }

        // 按分类划分已选词条：基础 / 附加 / 技能
        function partitionSelected() {
            const base = new Set([...selectedAttrs].filter(a => BASE_ATTRS.includes(a)));
            const additional = new Set([...selectedAttrs].filter(a => ADDITIONAL_ATTRS.includes(a)));
            const skill = new Set([...selectedAttrs].filter(a =>
                !BASE_ATTRS.includes(a) && !ADDITIONAL_ATTRS.includes(a)
            ));
            return { base, additional, skill };
        }

        // 筛选：同分类内「或」，不同分类间「且」；无选择时不展示结果
        function filterWeapons() {
            const resultsEl = document.getElementById('results');
            resultsEl.innerHTML = '';

            if (selectedAttrs.size === 0) {
                return;
            }

            const { base, additional, skill } = partitionSelected();
            const weaponEffects = w => [w.effect_1, w.effect_2, w.effect_3];

            const filtered = weaponsData.filter(w => {
                const effects = weaponEffects(w);
                const hasBase = base.size === 0 || effects.some(e => base.has(e));
                const hasAdditional = additional.size === 0 || effects.some(e => additional.has(e));
                const hasSkill = skill.size === 0 || effects.some(e => skill.has(e));
                return hasBase && hasAdditional && hasSkill;
            });

            currentAttrFilteredList = filtered;
            resultStarFilter = '';
            resultTypeFilter = '';
            renderResults(filtered);
        }

        // 渲染结果区：有结果时显示顶部筛选器 + 卡片列表
        function renderResults(filtered) {
            const resultsEl = document.getElementById('results');
            if (filtered.length === 0) {
                resultsEl.innerHTML = `<div class="no-results">未找到符合所选属性的武器</div>`;
                return;
            }

            resultsEl.innerHTML = `
                <div class="result-filters">
                    <label class="result-filter-item">
                        <span class="result-filter-label">星级</span>
                        <select id="filter-star" class="result-filter-select">
                            <option value="">全部</option>
                            ${allStarLevels.map(s => `<option value="${s}">${s}</option>`).join('')}
                        </select>
                    </label>
                    <label class="result-filter-item">
                        <span class="result-filter-label">类型</span>
                        <select id="filter-type" class="result-filter-select">
                            <option value="">全部</option>
                            ${allTypes.map(t => `<option value="${t}">${t}</option>`).join('')}
                        </select>
                    </label>
                </div>
                <div id="result-cards" class="result-cards"></div>
            `;

            document.getElementById('filter-star').addEventListener('change', function () {
                resultStarFilter = this.value;
                updateResultCards();
            });
            document.getElementById('filter-type').addEventListener('change', function () {
                resultTypeFilter = this.value;
                updateResultCards();
            });

            updateResultCards();
        }

        // 根据当前星级/类型筛选更新结果卡片列表
        function updateResultCards() {
            const list = currentAttrFilteredList.filter(w => {
                const matchStar = !resultStarFilter || w.star_level === resultStarFilter;
                const matchType = !resultTypeFilter || w.type === resultTypeFilter;
                return matchStar && matchType;
            });

            const container = document.getElementById('result-cards');
            if (!container) return;

            container.innerHTML = '';
            list.forEach(w => {
                const card = document.createElement('div');
                card.className = 'weapon-card';

                const nameEl = document.createElement('div');
                nameEl.className = 'weapon-name';
                nameEl.textContent = w.name;

                const typeEl = document.createElement('div');
                typeEl.className = 'weapon-type';
                typeEl.textContent = `【${w.star_level} ${w.type}】`;

                const effectsWrap = document.createElement('div');
                effectsWrap.className = 'weapon-effects';
                [w.effect_1, w.effect_2, w.effect_3].forEach(eff => {
                    const tag = document.createElement('span');
                    tag.className = 'weapon-effect-tag';
                    tag.textContent = eff;
                    effectsWrap.appendChild(tag);
                });

                card.appendChild(nameEl);
                card.appendChild(typeEl);
                card.appendChild(effectsWrap);
                container.appendChild(card);
            });
        }

        // 启动
        init().catch(err => {
            document.getElementById('results').innerHTML = `
                <div class="no-results">加载失败：${err.message}</div>
            `;
        });
    </script>
</body>
</html>